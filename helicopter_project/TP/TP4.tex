\documentclass[a4paper,10pt]{article}

\usepackage{graphicx}
\usepackage{amssymb}
\usepackage{color}
\usepackage{amsmath}
\usepackage[francais]{babel}
\usepackage[latin1]{inputenc}
\usepackage{fullpage}
\usepackage{verbatim}
\usepackage{fancyvrb}

\title{TP4 : enrichissement optimal de plans (1h30)}
\date{13 janvier 2016, 13h30}
\author{Nicolas Durrande, Rodolphe Le Riche, Victor Picheny}

\begin{document}
\maketitle
\paragraph{Objectifs :}
\begin{itemize}
 \item Construire un critère d'enrichissement de plans
 \item Optimiser ce critère avec CMA-ES
 \item Réaliser les expériences correspondantes
\end{itemize}

\section*{Construction du critère}
Une fois les métamodèles construits, on peut définir des critères d'enrichissement optimal des plans. Ecrivez un script prenant comme premier argument d'entrée un \textbf{vecteur de taille} $\mathbf{p \times 4}$, où $p$ est le nombre (quelconque) de points à rajouter et retournant la valeur du critère pour le plan enrichi. On codera ici le critère IMSE.

\subsection*{Aide :}
\paragraph{Variables d'optimisation :} Le vecteur est de la forme : $x_{new} = \{ x_1^{(1)}, \ldots, x_{4}^{(1)}, \ldots, x_1^{(p)}, \ldots, x_{4}^{(p)}  \}$, avec $\mathbf{x}^{(1)}, \ldots, \mathbf{x}^{(1)}$ les points à rajouter. Le vecteur \texttt{xnew} de taille $4p$ doit être réorganisé en matrice  \texttt{Xnew} $p \times 4$ à l'intérieur de la fonction IMSE :
 \begin{Verbatim}[frame=single,fontsize==\tiny]
Xnew <- matrix(xnew, ncol=4, byrow=TRUE)
\end{Verbatim}

\paragraph{Mise à jour du modèle :} on ajoute $p$ points au plan d'expériences pour calculer le critère, sans connaitre les réponses correspondantes. On peut remplacer ces réponses par une valeur quelconque (car la variance du krigeage ne dépend pas des réponses), par exemple la moyenne des observations. La solution la plus simple pour mettre à jour du modèle est de créer un nouveau modèle qui hérite de tous les paramètres de l'ancien, comme suit :
\begin{Verbatim}[frame=single,fontsize==\tiny]
newmodel=km(formula=model@trend.formula, design=rbind(model@X, Xnew), 
         response=c(model@y, rep(mean(model@y),nrow(Xnew))),
         covtype=model@covariance@name,coef.trend=model@trend.coef, 
         coef.cov=covparam2vect(model@covariance),coef.var=model@covariance@sd2, 
         noise.var=c(model@noise.var, rep(mean(model@noise.var),nrow(Xnew))))
\end{Verbatim}
Ici, \texttt{Xnew} est la matrice $p \times 4$ des nouvelles observations et \texttt{model} est le modèle de krigeage basé sur $n$ observations.

\paragraph{Intégration :} le critère IMSE est évalué par intégrale numérique, ce qui est potentiellement très coûteux. Le critère sera calculé comme la moyenne de la variance du krigeage (mis à jour) évaluée aux points d'intégration. On utilisera ici une méthode de Monte-Carlo. Les points d'intégration doivent être définis à l'extérieur de la fonction IMSE, de telle sorte qu'on définisse celle-ci de la façon suivante :
 \begin{Verbatim}[frame=single,fontsize==\tiny]
IMSE <- function(model, Xnew, integration.pts)
\end{Verbatim}

NB : les points d'intégration doivent être compris dans $[0,1]^4$. Cependant, on peut anticiper sur l'optimisation en choisissant les points uniquement dans les régions intéressantes : ainsi, on enrichira le plan de manière à améliorer le modèle uniquement dans la région de l'optimum. En pratique, on peut simplement réduire les bornes $[0,1]^4$ de manière à supprimer des régions identifiées comme non-optimales.

% \paragraph{En cas d'échec...} Une stratégie beaucoup plus simple consiste à effectuer une expérience là où la variance de prédiction est la plus grande. Ecrivez un script qui renvoie, pour un point donné de l'espace, la variance de prédiction du modèle (de régression ou de krigeage).

\section*{Recherche de nouveaux points}
A l'aide de votre script CMA-ES réalisé pendant le cours d'optimisation globale, recherchez l'ensemble de points $p$ qui minimisent le critère IMSE. Selon le temps imparti, la confiance dans le code réalisé et la volonté de résoudre le problème, on choisira $p$ entre 2 et 10. Il est également possible de réaliser l'enrichissement en plusieurs fois : l'optimisation est facilitée, mais cela oblige à réaliser plusieurs jeux d'expériences.
\medskip

Une fois les points déterminés, utilisez \texttt{draw\_multiple\_helico.R} pour générer les dessins et effectuez les nouvelles expériences, puis mettez à jour votre modèle de krigeage. L'emplacement des nouveaux points vous paraissent-ils logiques ? Quel impact ont-ils eu sur le modèle de krigeage ?

\end{document}